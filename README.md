# 💰 RAG Iishka - Анализ финансовых документов с AI-рекомендациями

RAG-сервис для анализа расходов по изображениям финансовых документов с интеллектуальными рекомендациями по сокращению затрат на основе базы знаний.

## 📋 Описание

Проект представляет собой интеллектуальный сервис для анализа личных финансов, который:
- 📸 **Распознает текст** из изображений финансовых документов (чеки, выписки, скриншоты)
- 🤖 **Анализирует транзакции** с помощью LLM (GigaChat)
- 🔍 **Ищет релевантную информацию** в базе знаний (тарифы банков, гос тарифы, учебники по фин грамотности)
- 💡 **Генерирует рекомендации** по сокращению расходов с конкретными советами и оценкой экономии

## 🏗️ Архитектура

Сервис построен на монолитной архитектуре с четким разделением слоев:

### Основные компоненты

1. **API Layer** (`internal/api/`)
   - REST API на базе **Fiber**
   - JWT аутентификация и авторизация
   - Swagger документация
   - Middleware для логирования и обработки ошибок

2. **Service Layer** (`internal/service/`)
   - **DocumentService** - обработка документов и координация workflow
   - **OCRService** - извлечение текста из изображений через GigaChat Vision API
   - **LLMService** - анализ транзакций с помощью GigaChat
   - **RAGService** - поиск релевантной информации в базе знаний
   - **RecommendationService** - генерация рекомендаций на основе транзакций и базы знаний
   - **AuthService** - управление пользователями и JWT токенами

3. **Repository Layer** (`internal/repository/`)
   - Работа с PostgreSQL через **pgx** и **Squirrel**
   - Репозитории для всех сущностей (Users, Documents, Transactions, Recommendations, KnowledgeBase)

4. **Infrastructure** (`pkg/`)
   - Конфигурация через переменные окружения
   - Структурированное логирование через **Uber Zap**
   - JWT управление токенами
   - Подключение к PostgreSQL

## 🛠️ Технологический стек

### Backend
- **Go 1.24+** - основной язык программирования
- **Fiber** - быстрый веб-фреймворк (аналог Express для Node.js)
- **pgx + Squirrel** - работа с PostgreSQL (connection pool + SQL builder)
- **Uber Zap** - структурированное логирование
- **JWT** - аутентификация и авторизация

### AI/ML
- **GigaChat API** - LLM для анализа транзакций
- **GigaChat Vision API** - OCR для извлечения текста из изображений
- **RAG (Retrieval-Augmented Generation)** - поиск релевантной информации в базе знаний

### Инфраструктура
- **PostgreSQL 16+** - основная база данных
- **Docker & Docker Compose** - контейнеризация БД
- **Swagger** - документация API

## 🚀 Быстрый старт

```bash
# 1. Клонировать или перейти в директорию
cd rag-iishka

# 2. Установить зависимости
go mod download

# 3. Запустить PostgreSQL в Docker
docker-compose up -d postgres

# 4. Создать файл .env на основе .env.example
cp .env.example .env
# Отредактируйте .env и укажите GIGACHAT_API_KEY

# 5. Наполнить базу знаний
make seed

# 6. Запустить сервис
make run
# или
go run cmd/rag-iishka/main.go
```

Подробная инструкция: см. раздел "Установка" ниже.

## 📊 Доступ к сервису

| Сервис | URL | Описание |
|--------|-----|----------|
| API | http://localhost:8080 | Основной API |
| Swagger | http://localhost:8080/swagger/index.html | Документация API |
| PostgreSQL | localhost:5432 (или 5433) | База данных |

## 💡 Основные возможности

### Управление пользователями
- ✅ Регистрация новых пользователей
- ✅ Аутентификация через JWT
- ✅ Обновление токенов доступа

### Загрузка и обработка документов
- ✅ Загрузка изображений финансовых документов (PNG, JPG, PDF)
- ✅ Автоматическое извлечение текста через GigaChat Vision API
- ✅ Анализ транзакций с помощью LLM
- ✅ Автоматическая классификация расходов по категориям

### Анализ транзакций
- ✅ Извлечение транзакций из документов
- ✅ Классификация по категориям (food, transport, utilities, shopping, entertainment, healthcare, education, other)
- ✅ Определение суммы, валюты и даты
- ✅ Подробное описание каждой транзакции

### Генерация рекомендаций
- ✅ Поиск релевантной информации в базе знаний
- ✅ Генерация конкретных рекомендаций по сокращению расходов
- ✅ Оценка потенциальной экономии
- ✅ Приоритизация рекомендаций (высокая/средняя/низкая)
- ✅ Связь рекомендаций с конкретными транзакциями

### База знаний
- ✅ Тарифы банков (Сбербанк, ВТБ, Альфа-Банк, Тинькофф)
- ✅ Государственные тарифы (госпошлины, налоговые льготы)
- ✅ Учебные материалы по финансовой грамотности
- ✅ Автоматическое наполнение из PDF файлов

## 📝 Примеры использования API

### 1. Регистрация пользователя
```bash
curl -X POST http://localhost:8080/user/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securepassword123",
    "first_name": "Иван",
    "last_name": "Иванов"
  }'
```

### 2. Вход в систему
```bash
curl -X POST http://localhost:8080/user/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securepassword123"
  }'
```

Ответ содержит `access_token` и `refresh_token`.

### 3. Загрузка документа
```bash
curl -X POST http://localhost:8080/api/v1/documents/upload \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -F "file=@/path/to/check.jpg"
```

### 4. Обработка документа
```bash
curl -X POST http://localhost:8080/api/v1/documents/{document_id}/process \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

При обработке:
- Текст извлекается из изображения через GigaChat Vision API
- Транзакции анализируются LLM и сохраняются в базу
- Генерируются рекомендации на основе базы знаний

### 5. Получение списка документов
```bash
curl -X GET http://localhost:8080/api/v1/documents \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## 📚 Структура проекта

```
rag-iishka/
├── cmd/
│   ├── rag-iishka/          # Точка входа приложения
│   │   └── main.go
│   └── seed/                # Команда для наполнения базы знаний
│       ├── main.go
│       └── *.pdf            # PDF файлы с тарифами и учебниками
│
├── internal/
│   ├── api/                 # HTTP API слой
│   │   ├── handlers/        # HTTP handlers
│   │   ├── router.go        # Настройка роутера
│   │   ├── request.go
│   │   └── response.go
│   │
│   ├── dto/                 # Data Transfer Objects
│   │   ├── auth.go
│   │   ├── document.go
│   │   └── recommendation.go
│   │
│   ├── models/              # Модели данных
│   │   ├── user.go
│   │   ├── document.go
│   │   ├── transaction.go
│   │   ├── recommendation.go
│   │   └── knowledge_base.go
│   │
│   ├── repository/          # Репозитории для работы с БД
│   │   ├── user_repository.go
│   │   ├── document_repository.go
│   │   ├── transaction_repository.go
│   │   ├── recommendation_repository.go
│   │   └── knowledge_repository.go
│   │
│   └── service/             # Бизнес-логика
│       ├── auth_service.go
│       ├── document_service.go
│       ├── ocr_service.go
│       ├── llm_service.go
│       ├── rag_service.go
│       ├── recommendation_service.go
│       └── utils.go
│
├── pkg/                     # Переиспользуемые пакеты
│   ├── auth/                # JWT аутентификация
│   ├── config/              # Конфигурация
│   ├── errors/              # Обработка ошибок
│   ├── logger/              # Логирование (Uber Zap)
│   ├── middleware/          # HTTP middleware
│   └── postgres/            # Подключение к БД
│
├── migrations/              # SQL миграции
│   └── 20241221220000_init.sql
│
├── docs/                    # Swagger документация
│   ├── docs.go
│   ├── swagger.json
│   └── swagger.yaml
│
├── uploads/                 # Загруженные файлы
│
├── docker-compose.yml       # Конфигурация PostgreSQL
├── Makefile                 # Команды для управления
├── go.mod
├── go.sum
└── README.md
```

## 🔧 Команды Makefile

```bash
make help          # Показать все доступные команды
make build         # Собрать приложение
make run           # Запустить приложение
make seed          # Наполнить базу знаний из PDF файлов
make db-up         # Запустить PostgreSQL в Docker
make db-down       # Остановить PostgreSQL
make db-reset      # Сбросить базу данных
make migrate-up    # Применить миграции
make migrate-down  # Откатить миграции
make migrate-status # Показать статус миграций
```

## 📖 Установка

### Требования

- **Go 1.24+**
- **Docker и Docker Compose** (для базы данных)
- **PostgreSQL 16+** (если не используете Docker)
- **GigaChat API ключ** (обязательно)
  - Получите ключ на [GigaChat](https://developers.sber.ru/gigachat)
  - Укажите ключ в переменной окружения `GIGACHAT_API_KEY`

### Пошаговая установка

1. **Клонируйте репозиторий:**
```bash
git clone <repository-url>
cd rag-iishka
```

2. **Установите зависимости:**
```bash
go mod download
```

3. **Запустите PostgreSQL в Docker:**
```bash
docker-compose up -d postgres
```

**Важно:** Если порт 5432 уже занят (например, локальным PostgreSQL), Docker Compose использует порт **5433** на хосте. В этом случае в `.env` файле укажите `DB_PORT=5433`.

База данных будет автоматически инициализирована миграциями из папки `migrations/`.

4. **Создайте файл `.env` на основе `.env.example`:**
```bash
cp .env.example .env
# Отредактируйте .env и укажите свои настройки
```

5. **Наполните базу знаний примерами данных:**
```bash
make seed
# или
go run ./cmd/seed/main.go
```

Это добавит в базу знаний:
- Тарифы банков (Сбербанк, ВТБ, Альфа-Банк, Тинькофф)
- Государственные тарифы (госпошлины, налоговые льготы)
- Учебные материалы по финансовой грамотности

6. **Запустите сервис:**
```bash
go run cmd/rag-iishka/main.go
# или
make run
```

### Работа с Docker Compose

**Запуск PostgreSQL:**
```bash
docker-compose up -d postgres
```

**Остановка PostgreSQL:**
```bash
docker-compose down
```

**Просмотр логов:**
```bash
docker-compose logs -f postgres
```

**Остановка и удаление данных:**
```bash
docker-compose down -v
```

**Проверка статуса:**
```bash
docker-compose ps
```

## 🗄️ База данных

### Основные сущности

- **users** - пользователи системы
- **documents** - загруженные финансовые документы
- **transactions** - извлеченные транзакции из документов
- **recommendations** - сгенерированные рекомендации по транзакциям
- **knowledge_base** - база знаний (тарифы банков, гос тарифы, учебники)

### Наполнение базы знаний

#### Автоматическое наполнение из PDF файлов

Команда seed автоматически обрабатывает PDF файлы из папки `cmd/seed/` и извлекает из них текст с помощью GigaChat Vision API:

```bash
make seed
```

Или напрямую:
```bash
go run ./cmd/seed/main.go
```

**Поддерживаемые PDF файлы:**
- **Тарифы банков** (bank_tariff):
  - `sberbank_*.pdf` - тарифы Сбербанка
  - `alfabank_*.pdf` - тарифы Альфа-Банка
  - `tinkoff_*.pdf` - тарифы Тинькофф
  - `vtb_*.pdf` - тарифы ВТБ

- **Государственные тарифы** (gov_tariff):
  - `gos_poshlina.pdf` - госпошлины
  - `lgoti_fiz_litsa.pdf` - льготы для физических лиц

- **Учебные материалы** (education):
  - `uchebnik.pdf` - учебник по финансовой грамотности
  - `knif_fin_gramotnost.pdf` - материалы по финансовой грамотности

**Как это работает:**
1. Команда сканирует папку `cmd/seed/` на наличие PDF файлов
2. Загружает каждый PDF в GigaChat через Vision API
3. Извлекает текст из документа
4. Создает запись в базе знаний с автоматически сгенерированным заголовком

**Примечание:** Убедитесь, что в `.env` файле указан `GIGACHAT_API_KEY` для работы Vision API.

## ⚙️ Конфигурация

Все настройки задаются через переменные окружения (см. `.env.example`):

### Сервер
- **SERVER_PORT** - Порт сервера (по умолчанию: 8080)

### База данных
- **DB_HOST** - Хост PostgreSQL (по умолчанию: localhost)
- **DB_PORT** - Порт PostgreSQL (по умолчанию: 5432)
- **DB_USER** - Пользователь БД
- **DB_PASSWORD** - Пароль БД
- **DB_NAME** - Имя базы данных
- **DB_SSLMODE** - Режим SSL (по умолчанию: disable)

### JWT
- **JWT_SECRET_KEY** - Секретный ключ для JWT (обязательно)
- **JWT_EXPIRATION** - Время жизни access token (по умолчанию: 24h)
- **JWT_REFRESH_EXP** - Время жизни refresh token (по умолчанию: 168h)

### GigaChat API
- **GIGACHAT_API_KEY** - API ключ GigaChat (обязательно)
  - Получите ключ на [GigaChat](https://developers.sber.ru/gigachat)
  - Используется для LLM анализа и Vision API (OCR)
- **GIGACHAT_SCOPE** - Scope для GigaChat API (по умолчанию: GIGACHAT_API_PERS)
- **GIGACHAT_INSECURE_SKIP_VERIFY** - Пропустить проверку TLS сертификата (true/false, по умолчанию true для dev окружения)

### RAG
- **RAG_TOP_K** - Количество релевантных документов из базы знаний (по умолчанию: 5)
- **RAG_SIMILARITY_THRESHOLD** - Порог схожести для поиска (по умолчанию: 0.7)

### Логирование
- **LOG_LEVEL** - Уровень логирования (debug, info, warn, error, по умолчанию: info)

## 🔄 Workflow обработки документа

```
1. Пользователь загружает изображение документа
   ↓
2. Документ сохраняется в файловую систему (uploads/)
   ↓
3. Пользователь запускает обработку документа
   ↓
4. OCR Service извлекает текст через GigaChat Vision API
   ↓
5. LLM Service анализирует текст и извлекает транзакции
   ↓
6. Транзакции сохраняются в базу данных
   ↓
7. Для каждой транзакции:
   - RAG Service ищет релевантную информацию в базе знаний
   - Recommendation Service генерирует рекомендации на основе транзакции и найденной информации
   ↓
8. Рекомендации сохраняются в базу данных
   ↓
9. Пользователь получает результат с транзакциями и рекомендациями
```

## 🧪 Разработка

### Генерация Swagger документации

После добавления или изменения API endpoints, необходимо перегенерировать Swagger документацию:

```bash
# Установить swag (если еще не установлен)
go install github.com/swaggo/swag/cmd/swag@latest

# Сгенерировать документацию
swag init -g cmd/rag-iishka/main.go -o ./docs
```

Документация будет доступна по адресу: http://localhost:8080/swagger/index.html

### Добавление новых функций

1. Создайте модель в `internal/models/`
2. Создайте DTO в `internal/dto/`
3. Создайте репозиторий в `internal/repository/`
4. Создайте сервис в `internal/service/`
5. Создайте handler в `internal/api/handlers/`
6. Добавьте роуты в `internal/api/router.go`

### Запуск тестов

```bash
go test ./...
```

## 🎯 Особенности реализации

### RAG (Retrieval-Augmented Generation)
- Поиск релевантной информации в базе знаний на основе транзакций
- Использование векторного поиска для нахождения похожих документов
- Контекстная генерация рекомендаций на основе найденной информации

### OCR через GigaChat Vision API
- Высокая точность распознавания текста из изображений
- Поддержка различных форматов (PNG, JPG, PDF)
- Обработка сложных документов (чеки, выписки, скриншоты)

### Анализ транзакций через LLM
- Структурированное извлечение данных из текста
- Автоматическая классификация по категориям
- Определение суммы, валюты и даты транзакции

### Генерация рекомендаций
- Конкретные, выполнимые советы по сокращению расходов
- Оценка потенциальной экономии
- Приоритизация рекомендаций
- Связь с информацией из базы знаний

### Безопасность
- JWT аутентификация и авторизация
- Хеширование паролей
- Валидация входных данных
- CORS настройки

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────┐
│           RAG Iishka Application                │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌──────────────┐         ┌──────────────┐    │
│  │  Fiber API   │◄───────►│  PostgreSQL  │    │
│  │  (REST)      │         │   Database   │    │
│  └──────┬───────┘         └──────────────┘    │
│         │                                       │
│         │                  ┌──────────────┐    │
│         ├─────────────────►│  GigaChat    │    │
│         │                  │  Vision API  │    │
│         │                  │   (OCR)      │    │
│         │                  └──────────────┘    │
│         │                                       │
│         │                  ┌──────────────┐    │
│         ├─────────────────►│  GigaChat    │    │
│         │                  │  LLM API     │    │
│         │                  │  (Analysis)  │    │
│         │                  └──────────────┘    │
│         │                                       │
│  ┌──────▼──────────────────────────────────┐  │
│  │         Service Layer                    │  │
│  │  ┌──────────────┐  ┌──────────────┐    │  │
│  │  │   Document   │  │     OCR      │    │  │
│  │  │   Service    │  │   Service    │    │  │
│  │  └──────────────┘  └──────────────┘    │  │
│  │  ┌──────────────┐  ┌──────────────┐    │  │
│  │  │     LLM      │  │     RAG      │    │  │
│  │  │   Service    │  │   Service    │    │  │
│  │  └──────────────┘  └──────────────┘    │  │
│  │  ┌──────────────┐                      │  │
│  │  │Recommendation│                      │  │
│  │  │   Service    │                      │  │
│  │  └──────────────┘                      │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
│  ┌──────────────┐                              │
│  │   Uploads    │                              │
│  │  Directory   │                              │
│  └──────────────┘                              │
└─────────────────────────────────────────────────┘
```

## 🔒 Безопасность

В production окружении рекомендуется:
- Использовать HTTPS/TLS
- Настроить rate limiting
- Использовать secrets для паролей и API ключей
- Настроить CORS для конкретных доменов
- Добавить валидацию и санитизацию входных данных
- Регулярно обновлять зависимости

## 📖 Документация API

После запуска сервиса, Swagger документация доступна по адресу:
- http://localhost:8080/swagger/index.html

## 🤝 Вклад

Проект создан в образовательных целях для демонстрации использования RAG (Retrieval-Augmented Generation) в финансовых приложениях.

## 📄 Лицензия

MIT License

## ✨ Основные возможности

✅ **Загрузка документов** - поддержка PNG, JPG, PDF  
✅ **OCR** - извлечение текста через GigaChat Vision API  
✅ **Анализ транзакций** - автоматическое извлечение и классификация расходов  
✅ **RAG поиск** - поиск релевантной информации в базе знаний  
✅ **Рекомендации** - конкретные советы по сокращению расходов  
✅ **База знаний** - тарифы банков, гос тарифы, учебники  
✅ **JWT аутентификация** - безопасный доступ к API  
✅ **Swagger документация** - полная документация API  

---

**Создано с ❤️ на Go**
